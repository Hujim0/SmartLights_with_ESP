<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP LED</title>
</head>

<body>
    <h1>Change how your strip looks!</h1>
    <p>
        <label>Light switch</label>
        <input type="checkbox" id="light_switch_checkbox" />
    </p>
    <p>
        <label>Brightness</label>
        <input type="range" id="brightness_slider" min="5" max="255" />
    </p>
    <p>
        <label> Light mode</label>
        <select id="mode_switch_select">
            <option>Static mode</option>
            <option>Rainbow mode</option>
            <option>Wave mode</option>
        </select>
    </p>
    <p id="speed_input_holder" hidden>
        <label>Speed</label>
        <input type="range" id="speed_input" min="0" max="50">
    </p>
    <p id="count_input_holder" hidden>
        <label>count</label>
        <input type="number" id="count_input">
    </p>
    <p id="intensity_input_holder" hidden>
        <label>Intensity</label>
        <input type="range" id="intensity_input" min="0" max="100">
    </p>
    <p id="length_input_holder" hidden>
        <label>Length</label>
        <input type="number" id="length_input">
    </p>
    <p id="reversed_input_holder" hidden>
        <label>Reversed</label>
        <input type="checkbox" id="reversed_input">
    </p>
    <p id="color_input_holder">
        <label>
            Color
        </label>
        <input type="color" id="color_picker" />
    </p>
    <p></p>
    <p></p>
    <hr />
    <p><label>Made by <a href="https://github.com/Hujim0">hujimo</a></label></p>
    <p><label>Licence - MIT</label></p>
</body>

<script type="text/javascript">

    var gateway = `ws://${window.location.host}/ws`;
    var websocket;

    window.addEventListener('load', BeginWebSocket);

    function BeginWebSocket(event) {
        console.log('Trying to open a WebSocket connection...');
        websocket = new WebSocket(gateway);
        websocket.onopen = onOpen;
        websocket.onclose = onClose;
        websocket.onmessage = onMessage;
    }

    function onOpen(event) {
        console.log('Connection opened');
        websocket.send('hi from server');
    }

    function onClose(event) {
        console.log('Connection closed');
        setTimeout(BeginWebSocket, 2000);
    }

    var modes = null;

    const OnGetPreferences = new Event("onGetPreferences", { bubbles: true });

    function onMessage(event) {
        console.log(event.data);
        if (modes == null) {
            modes = JSON.parse(event.data);
            window.dispatchEvent(OnGetPreferences);
        }
    }

    //---------------------------------------------------------------------------

    var checkbox = document.getElementById("light_switch_checkbox");

    window.addEventListener("onGetPreferences", (event) => {

        checkbox.checked = modes.light_switch;
    });

    checkbox.addEventListener("change", (event) => {

        modes.light_switch = event.currentTarget.checked;

        //json formatting
        websocket.send("{\"event\":\"light_switch\"," +
            "\"value\":" + event.currentTarget.checked +
            "}");
    });

    //---------------------------------------------------------------------------

    var color_picker = document.getElementById("color_picker");
    //color picker sends args only after updating the mode 
    var speed_input = document.getElementById("speed_input");
    speed_input.addEventListener("change", SendCurrentArgs);
    var count_input = document.getElementById("count_input");
    count_input.addEventListener("change", SendCurrentArgs);
    var intensity_input = document.getElementById("intensity_input");
    intensity_input.addEventListener("change", SendCurrentArgs);
    var length_input = document.getElementById("length_input");
    length_input.addEventListener("change", SendCurrentArgs);
    var reversed_input = document.getElementById("reversed_input");
    reversed_input.addEventListener("change", SendCurrentArgs);

    var select = document.getElementById("mode_switch_select");

    window.addEventListener("onGetPreferences", (event) => {

        select.selectedIndex = modes.mode;
        UpdateModeElements();
    });
    select.addEventListener("change", (event) => {
        ChangeMode(event.currentTarget.selectedIndex);
    });

    //send update func
    function ChangeMode(id) {
        if (modes == null) return;

        modes.mode = id;

        UpdateModeElements();

        SendCurrentArgs();

    }

    function SendCurrentArgs() {
        if (modes == null) return;

        websocket.send("{\"event\":\"mode_switch\"," +
            "\"value\":" + modes.mode + GetArgs() + "}");
    }

    function GetArgs() {
        var current_mode = modes.mode;

        var args = "";

        //-----color------
        var hasColor = modes.args[current_mode].r != null;
        if (hasColor) {
            args += (args == "") ? ",\"args\":{" : ","; //checks if its the first arguement, if not, continue with a comma

            args += "\"r\":" + modes.args[current_mode].r + "," +
                "\"g\":" + modes.args[current_mode].g + "," +
                "\"b\":" + modes.args[current_mode].b;
        }
        //------speed-------
        var hasSpeed = modes.args[current_mode].speed != null;
        if (hasSpeed) {
            modes.args[current_mode].speed = speed_input.value;
            args += (args == "") ? ",\"args\":{" : ",";
            args += "\"speed\":" + speed_input.value;
        }

        //------count-------
        var hasCount = modes.args[current_mode].count != null;
        if (hasCount) {
            modes.args[current_mode].count = count_input.value;

            args += (args == "") ? ",\"args\":{" : ",";
            args += "\"count\":" + count_input.value;
        }
        //----intensity-----
        var hasIntensity = modes.args[current_mode].intensity != null;
        if (hasIntensity) {
            modes.args[current_mode].intensity = intensity_input.value;

            args += (args == "") ? ",\"args\":{" : ",";
            args += "\"intensity\":" + intensity_input.value;
        }
        //------length------
        var hasLength = modes.args[current_mode].length != null;
        if (hasLength) {
            modes.args[current_mode].length = length_input.value;

            args += (args == "") ? ",\"args\":{" : ",";
            args += "\"length\":" + length_input.value;
        }

        //-----reversed------
        var hasReversed = modes.args[current_mode].reversed != null;
        if (hasReversed) {
            modes.args[current_mode].reversed = reversed_input.checked;

            args += (args == "") ? ",\"args\":{" : ",";
            args += "\"reversed\":" + reversed_input.checked;
        }

        args += "}";

        console.log(args);

        return args;
    }

    function UpdateModeElements() {
        var current_mode = modes.mode;

        //-----color-------
        var hasColor = modes.args[current_mode].r != null;

        color_picker.parentElement.hidden = !hasColor;
        if (hasColor) {
            var r = modes.args[current_mode].r;
            var g = modes.args[current_mode].g;
            var b = modes.args[current_mode].b;

            color_picker.value = rgbToHex(r, g, b);
        }
        //------speed-------
        var hasSpeed = modes.args[current_mode].speed != null;
        speed_input.parentElement.hidden = !hasSpeed;
        if (hasSpeed) {
            speed_input.value = modes.args[current_mode].speed;
        }
        //------count-------
        var hasCount = modes.args[current_mode].count != null;
        count_input.parentElement.hidden = !hasCount;
        if (hasCount) {

            count_input.value = modes.args[current_mode].count;
        }
        //----intensity-----
        var hasIntensity = modes.args[current_mode].intensity != null;
        intensity_input.parentElement.hidden = !hasIntensity;
        if (hasIntensity) {
            intensity_input.value = modes.args[current_mode].intensity;
        }
        //------length------
        var hasLength = modes.args[current_mode].length != null;
        length_input.parentElement.hidden = !hasLength;
        if (hasLength) {
            length_input.value = modes.args[current_mode].length;
        }

        //-----reversed------
        var hasReversed = modes.args[current_mode].reversed != null;
        reversed_input.parentElement.hidden = !hasReversed;
        if (hasReversed) {
            reversed_input.checked = modes.args[current_mode].reversed;
        }
    }
    //---------------------------------------------------------------------------

    color_picker.addEventListener("change", (event) => {

        var color = color_picker.value;

        var current_mode = modes.mode;

        const r = parseInt(color.substr(1, 2), 16);
        modes.args[current_mode].r = r;
        const g = parseInt(color.substr(3, 2), 16);
        modes.args[current_mode].g = g;
        const b = parseInt(color.substr(5, 2), 16);
        modes.args[current_mode].b = b;

        SendCurrentArgs();
    });

    function decToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return "#" + decToHex(r) + decToHex(g) + decToHex(b);

    }

    //---------------------------------------------------------------------------

    slider = document.getElementById("brightness_slider");

    window.addEventListener("onGetPreferences", (event) => {

        slider.value = modes.brightness;
    });

    slider.addEventListener("change", (event) => {
        modes.brightness = event.target.value;

        websocket.send("{\"event\":\"brightness\"," +
            "\"value\":" + event.target.value +
            "}");

    });

</script>

</html>