<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP LED</title>
</head>

<body>
    <h1>Change how your strip looks!</h1>
    <p>
        <label>Light switch</label>
        <input type="checkbox" id="light_switch_checkbox" />
    </p>
    <p>
        <label>Brightness</label>
        <input type="range" id="brightness_slider" min="5" max="255" />
    </p>
    <p>
        <label> Light mode</label>
        <select id="mode_switch_select">
            <option>Static mode</option>
            <option>Rainbow mode</option>
            <option>Wave mode</option>
            <option>Sky mode</option>
        </select>
    </p>
    <p hidden>
        <label>Edit</label>
        <input type="checkbox" id="edit_input">
    </p>
    <p hidden>
        <label>Speed</label>
        <input type="range" id="speed_input" min="0" max="50">
    </p>
    <p hidden>
        <label>count</label>
        <input type="number" id="count_input">
    </p>
    <p hidden>
        <label>Intensity</label>
        <input type="range" id="intensity_input" min="0" max="100">
    </p>
    <p hidden>
        <label>Length</label>
        <input type="number" id="length_input">
    </p>
    <p hidden>
        <label>Start</label>
        <input type="number" id="start_input">
    </p>
    <p hidden>
        <label>End</label>
        <input type="number" id="end_input">
    </p>
    <p hidden>
        <label>Reversed</label>
        <input type="checkbox" id="reversed_input">
    </p>
    <p hidden>
        <label>Color</label>
        <input type="color" id="color_picker" />
    </p>
    <p></p>
    <p></p>
    <hr />
    <p><label>Made by <a href="https://github.com/Hujim0">hujimo</a></label></p>
    <p><label>Licence - MIT</label></p>
</body>

<script type="text/javascript">

    var gateway = `ws://${window.location.host}/ws`;
    var websocket;

    window.addEventListener('load', BeginWebSocket);

    function BeginWebSocket(event) {
        console.log('Trying to open a WebSocket connection...');
        websocket = new WebSocket(gateway);
        websocket.onopen = onOpen;
        websocket.onclose = onClose;
        websocket.onmessage = onMessage;
    }

    function onOpen(event) {
        console.log('Connection opened');
    }

    function onClose(event) {
        console.log('Connection closed');
        modes = null;
        window.dispatchEvent(OnLostConnection);
        setTimeout(BeginWebSocket, 2000);
    }

    var modes = null;

    const OnGetPreferences = new Event("onGetPreferences");
    const OnLostConnection = new Event("onLostConnection");

    function onMessage(event) {
        console.log(event.data);
        if (modes == null) {
            modes = JSON.parse(event.data);
            window.dispatchEvent(OnGetPreferences);
        }
    }

    //---------------------------------------------------------------------------

    var checkbox = document.getElementById("light_switch_checkbox");

    window.addEventListener("onGetPreferences", (event) => {
        checkbox.checked = modes.light_switch;
        checkbox.addEventListener("click", OnLightSwitchChanged);
    });
    window.addEventListener("onLostConnection", (event) => {
        checkbox.removeEventListener("click", OnLightSwitchChanged);
    });

    function OnLightSwitchChanged() {
        modes.light_switch = checkbox.checked;

        //json formatting
        websocket.send("{\"event\":\"light_switch\"," +
            "\"value\":" + checkbox.checked +
            "}");
    }

    //---------------------------------------------------------------------------

    var color_picker = document.getElementById("color_picker");

    var speed_input = document.getElementById("speed_input");
    var count_input = document.getElementById("count_input");
    var intensity_input = document.getElementById("intensity_input");
    var length_input = document.getElementById("length_input");
    var reversed_input = document.getElementById("reversed_input");
    var start_input = document.getElementById("start_input");
    var end_input = document.getElementById("end_input");

    inputs_dictionary = [
        {
            "elem": edit_input,
            "property": "edit"
        },
        {
            "elem": speed_input,
            "property": "speed"
        },
        {
            "elem": intensity_input,
            "property": "intensity"
        },
        {
            "elem": length_input,
            "property": "length"
        },
        {
            "elem": reversed_input,
            "property": "reversed"
        },
        {
            "elem": count_input,
            "property": "count"
        },
        {
            "elem": start_input,
            "property": "start"
        },
        {
            "elem": end_input,
            "property": "end"
        }
    ]

    window.addEventListener("onGetPreferences", (event) => {
        //color picker sends args only after updating the mode 
        for (var i = 0; i < inputs_dictionary.length; i++) {
            inputs_dictionary[i].elem.addEventListener("change", SendCurrentArgs);
        }
    });

    window.addEventListener("onLostConnection", (event) => {
        //color picker sends args only after updating the mode 
        for (var i = 0; i < inputs_dictionary.length; i++) {
            inputs_dictionary[i].elem.removeEventListener("change", SendCurrentArgs);
        }
    });


    var select = document.getElementById("mode_switch_select");

    window.addEventListener("onGetPreferences", (event) => {

        select.selectedIndex = modes.mode;
        UpdateModeElements();

        select.addEventListener("change", (event) => {
            ChangeMode(event.currentTarget.selectedIndex);
        });
    });

    window.addEventListener("onLostConnection", (event) => (event) => {
        select.removeEventListener("change", (event) => {
            ChangeMode(event.currentTarget.selectedIndex);
        });
    });

    //send update func
    function ChangeMode(id) {
        if (modes == null) return;

        modes.mode = id;

        UpdateModeElements();

        SendCurrentArgs();

    }

    function SendCurrentArgs() {
        if (modes == null) return;

        websocket.send("{\"event\":\"mode_switch\"," +
            "\"value\":" + modes.mode + GetArgs() + "}");
    }

    function GetArgs() {
        var current_mode = modes.mode;

        var args = ",\"args\":{";

        var hasColor = modes.args[current_mode].r != null;
        if (hasColor) {
            args += "\"r\":" + modes.args[current_mode].r + "," +
                "\"g\":" + modes.args[current_mode].g + "," +
                "\"b\":" + modes.args[current_mode].b + ",";
        }

        for (var i = 0; i < inputs_dictionary.length; i++) {
            args += checkHasArg(inputs_dictionary[i].elem,
                inputs_dictionary[i].property);
        }

        if (args == ",\"args\":{") { //none of the args are found
            return "";
        }

        if (args.endsWith(",")) {
            args = args.substring(0, args.length - 1);
        }

        args += "}";

        console.log(args);

        return args;
    }

    function checkHasArg(elem, property) {
        var hasProperty = modes.args[modes.mode][property] != null;
        if (!hasProperty) {
            return "";
        }

        if (property == "reversed" || property == "edit") {
            modes.args[modes.mode][property] = elem.checked;
            return "\"" + property + "\":" + elem.checked + ",";
        }

        modes.args[modes.mode][property] = elem.value;

        return "\"" + property + "\":" + elem.value + ",";
    }

    function UpdateModeElements() {
        var current_mode = modes.mode;
        //-----color-------
        var hasColor = modes.args[current_mode].r != null;

        color_picker.parentElement.hidden = !hasColor;
        if (hasColor) {
            var r = modes.args[current_mode].r;
            var g = modes.args[current_mode].g;
            var b = modes.args[current_mode].b;

            color_picker.value = rgbToHex(r, g, b);
        }

        for (var i = 0; i < inputs_dictionary.length; i++) {
            checkElement(inputs_dictionary[i].elem,
                inputs_dictionary[i].property);
        }
    }

    function checkElement(elem, property) {
        var hasProperty = modes.args[modes.mode][property] != null;
        elem.parentElement.hidden = !hasProperty;
        if (hasProperty) {
            if (property == "reversed" || property == "edit") {
                elem.checked = modes.args[modes.mode][property];
                return;
            }
            elem.value = modes.args[modes.mode][property];
        }
    }
    //---------------------------------------------------------------------------

    window.addEventListener("onGetPreferences", (event) => {
        color_picker.addEventListener("change", OnColorPickerUpdate);
    });

    window.addEventListener("onLostConnection", (event) => {
        color_picker.removeEventListener("change", OnColorPickerUpdate);
    });


    function OnColorPickerUpdate() {
        var color = color_picker.value;
        var current_mode = modes.mode;
        const r = parseInt(color.substr(1, 2), 16);
        modes.args[current_mode].r = r;
        const g = parseInt(color.substr(3, 2), 16);
        modes.args[current_mode].g = g;
        const b = parseInt(color.substr(5, 2), 16);
        modes.args[current_mode].b = b;

        SendCurrentArgs();
    }

    function decToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return "#" + decToHex(r) + decToHex(g) + decToHex(b);
    }

    //---------------------------------------------------------------------------

    slider = document.getElementById("brightness_slider");

    window.addEventListener("onGetPreferences", (event) => {

        slider.value = modes.brightness;

        slider.addEventListener("change", OnBrightnessUpdate);
    });

    window.addEventListener("onLostConnection", (event) => {
        slider.removeEventListener("change", OnBrightnessUpdate);
    });

    function OnBrightnessUpdate() {
        modes.brightness = slider.value;

        websocket.send("{\"event\":\"brightness\"," +
            "\"value\":" + slider.value +
            "}");

    }


</script>

</html>