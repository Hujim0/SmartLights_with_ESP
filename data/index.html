<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP LED</title>
</head>

<body>
    <h1>Change how your strip looks!</h1>
    <p>
        <label>Light switch</label>
        <input type="checkbox" id="light_switch_checkbox" />
    </p>
    <p>
        <label>Brightness</label>
        <input type="range" id="brightness_slider" min="5" max="255" value="5" />
    </p>
    <p>
        <label> Light mode</label>
        <select id="mode_switch_select">
            <option>Static mode</option>
            <option>Rainbow mode</option>
            <option>Wave mode</option>
            <option>Sky mode</option>
        </select>
    </p>
    <p hidden>
        <label>Edit</label>
        <input type="checkbox" id="edit_input">
    </p>
    <p hidden>
        <label>Speed</label>
        <input type="range" id="speed_input" min="0" max="50">
    </p>
    <p hidden>
        <label>count</label>
        <input type="number" id="count_input">
    </p>
    <p hidden>
        <label>Intensity</label>
        <input type="range" id="intensity_input" min="0" max="100">
    </p>
    <p hidden>
        <label>Length</label>
        <input type="number" id="length_input">
    </p>
    <p hidden>
        <label>Start</label>
        <input type="number" id="start_input">
    </p>
    <p hidden>
        <label>End</label>
        <input type="number" id="end_input">
    </p>
    <p hidden>
        <label>Reversed</label>
        <input type="checkbox" id="reversed_input">
    </p>
    <p hidden>
        <label>Color</label>
        <input type="color" id="color_picker" />
    </p>
    <p></p>
    <p></p>
    <hr />
    <p><label>Made by <a href="https://github.com/Hujim0">hujimo</a></label></p>
    <p><label>Licence - MIT</label></p>
</body>

<script type="text/javascript">

    var gateway = `ws://${window.location.host}/ws`;
    var websocket;

    window.addEventListener('load', BeginWebSocket);

    function BeginWebSocket(event) {
        console.log('Trying to open a WebSocket connection...');
        websocket = new WebSocket(gateway);
        websocket.onopen = onOpen;
        websocket.onclose = onClose;
        websocket.onmessage = onMessage;
    }

    function onOpen(event) {
        console.log('Connection opened');
    }

    function onClose(event) {
        console.log('Connection closed');
        preferences = null;
        current_mode = null;
        window.dispatchEvent(OnLostConnection);
        location.reload();
        setTimeout(BeginWebSocket, 2000);

    }

    var current_mode = null;
    var preferences = null;

    const OnGetPreferences = new Event("onGetPreferences");
    const OnGetMode = new Event("onGetMode");
    const OnLostConnection = new Event("onLostConnection");

    function onMessage(event) {
        if (preferences == null) {
            preferences = JSON.parse(event.data);
            window.dispatchEvent(OnGetPreferences);
            return;
        }
        console.log(event.data);
        current_mode = JSON.parse(event.data);
        window.dispatchEvent(OnGetMode);
    }

    window.addEventListener("onGetPreferences", (event) => {
        console.log("Got preferences!")
    });
    window.addEventListener("onLostConnection", (event) => {
        console.log("Lost connection!")
        preferences = null;
    });

    //---------------------------------------------------------------------------

    var checkbox = document.getElementById("light_switch_checkbox");

    window.addEventListener("onGetPreferences", (event) => {
        checkbox.checked = preferences.light_switch;
        checkbox.addEventListener("click", OnLightSwitchChanged);
    });
    window.addEventListener("onLostConnection", (event) => {
        checkbox.removeEventListener("click", OnLightSwitchChanged);
    });

    function OnLightSwitchChanged() {
        preferences.light_switch = checkbox.checked;

        //json formatting
        websocket.send("{\"event\":\"light_switch\"," +
            "\"value\":" + checkbox.checked +
            "}");
    }

    //---------------------------------------------------------------------------

    var brigthness_slider = document.getElementById("brightness_slider");

    window.addEventListener("onGetPreferences", (event) => {

        brigthness_slider.value = preferences.brightness;

        brigthness_slider.addEventListener("change", OnBrightnessUpdate);
        brigthness_slider.addEventListener("input", handleBrigthnessInput);
    });

    window.addEventListener("onLostConnection", (event) => {
        brigthness_slider.removeEventListener("change", OnBrightnessUpdate);
        brigthness_slider.removeEventListener("input", handleBrigthnessInput);
    });

    var sentBrigthnessStreamEvent = false;
    function OnBrightnessUpdate() {
        preferences.brightness = brigthness_slider.value;

        websocket.send("]");
        console.log("closing stream");
        sentBrigthnessStreamEvent = false;

        websocket.send("{\"event\":\"brightness\"," +
            "\"value\":" + brigthness_slider.value +
            "}");


    }

    function handleBrigthnessInput() {
        if (!sentBrigthnessStreamEvent) {
            console.log("starting slider event");
            websocket.send("{\"event\":\"open_stream\"," +
                "\"value\":\"brightness\"" +
                "}");
            sentBrigthnessStreamEvent = true;
        }
        console.log(brigthness_slider.value);
        websocket.send(brigthness_slider.value);
    }
    //---------------------------------------------------------------------------
    var color_picker = document.getElementById("color_picker");

    window.addEventListener("onGetPreferences", (event) => {
        color_picker.addEventListener("change", OnColorPickerUpdate);
        //color_picker.addEventListener("input", OnColorPickerUpdate);
    });

    window.addEventListener("onLostConnection", (event) => {
        color_picker.removeEventListener("change", OnColorPickerUpdate);
        //color_picker.addEventListener("input", OnColorPickerUpdate);
    });


    function OnColorPickerUpdate() {
        //current_mode.color = color_picker.value;

        //SendCurrentArgs();
    }

    var sentColorStreamEvent = false;
    function handleColorInput() {
        if (!sentColorStreamEvent) {
            console.log("starting color event");
            websocket.send("{\"event\":\"open_stream\"," +
                "\"value\":\"color\"" +
                "}");
            sentBrigthnessStreamEvent = true;
        }
    }

    //---------------------------------------------------------------------------

    var speed_input = document.getElementById("speed_input");
    var count_input = document.getElementById("count_input");
    var intensity_input = document.getElementById("intensity_input");
    var length_input = document.getElementById("length_input");
    var reversed_input = document.getElementById("reversed_input");
    var start_input = document.getElementById("start_input");
    var end_input = document.getElementById("end_input");

    inputs_dictionary = [
        {
            "elem": edit_input,
            "property": "edit"
        },
        {
            "elem": speed_input,
            "property": "speed"
        },
        {
            "elem": intensity_input,
            "property": "intensity"
        },
        {
            "elem": length_input,
            "property": "length"
        },
        {
            "elem": reversed_input,
            "property": "reversed"
        },
        {
            "elem": count_input,
            "property": "count"
        },
        {
            "elem": start_input,
            "property": "start"
        },
        {
            "elem": end_input,
            "property": "end"
        },
        {
            "elem": color_picker,
            "property": "color"
        }
    ]

    window.addEventListener("onGetPreferences", (event) => {
        //color picker sends args only after updating the mode 
        for (var i = 0; i < inputs_dictionary.length; i++) {
            inputs_dictionary[i].elem.addEventListener("change", SendCurrentArgs);
        }
    });

    window.addEventListener("onLostConnection", (event) => {
        //color picker sends args only after updating the mode 
        for (var i = 0; i < inputs_dictionary.length; i++) {
            inputs_dictionary[i].elem.removeEventListener("change", SendCurrentArgs);
        }
    });


    var select = document.getElementById("mode_switch_select");

    window.addEventListener("onGetPreferences", (event) => {

        select.selectedIndex = preferences.mode;
        RequestArgs(preferences.mode);

        select.addEventListener("change", (event) => {
            ChangeMode(event.currentTarget.selectedIndex);
        });
    });

    window.addEventListener("onLostConnection", (event) => (event) => {
        select.removeEventListener("change", (event) => {
            ChangeMode(event.currentTarget.selectedIndex);
        });
    });

    //send update func
    function ChangeMode(id) {
        preferences.mode = id;

        window.addEventListener("onGetMode", OnGetArgs);

        websocket.send("{\"event\":\"mode_switch\"," +
            "\"value\":" + preferences.mode +
            "}");
    }

    function RequestArgs(id) {

        window.addEventListener("onGetMode", OnGetArgs);

        websocket.send("{\"event\":\"mode_args_request\"," +
            "\"value\":" + preferences.mode +
            "}");
    }

    function OnGetArgs() {
        UpdateModeElements();
        window.removeEventListener("onGetMode", OnGetArgs);
    }

    function SendCurrentArgs() {
        ApplyArgs();
        websocket.send(JSON.stringify(current_mode));
    }

    function ApplyArgs() {
        for (var i = 0; i < inputs_dictionary.length; i++) {
            ApplyArg(inputs_dictionary[i].elem,
                inputs_dictionary[i].property);
        }
    }

    function ApplyArg(elem, property) {
        var hasProperty = current_mode[property] != null;

        if (!hasProperty) return;

        if (property == "reversed" || property == "edit") {
            current_mode[property] = elem.checked;
            return;
        }

        current_mode[property] = elem.value;
    }

    function UpdateModeElements() {
        for (var i = 0; i < inputs_dictionary.length; i++) {
            checkElement(inputs_dictionary[i].elem,
                inputs_dictionary[i].property);
        }
    }

    function checkElement(elem, property) {
        var hasProperty = current_mode[property] != null;
        elem.parentElement.hidden = !hasProperty;
        if (!hasProperty) return;

        if (property == "reversed" || property == "edit") {
            elem.checked = current_mode[property];
            return;
        }
        elem.value = current_mode[property];
    }

</script>

</html>